<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>notcord â€” multi-channel</title>
  <style>
    :root{
      --theme-1: #071226;
      --theme-2: #07101a;
      --panel: rgba(11,18,32,0.95);
      --muted: #9aa4b2;
      --accent: #5865f2;
      --msg-bg: #111827;
      --me-bg: #2b3440;
      --border: rgba(255,255,255,0.06);
      --text: #e6eef6;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:var(--text);
      background:linear-gradient(180deg,var(--theme-1) 0%, var(--theme-2) 100%);
    }

    /* layout: left sidebar, main, right players */
    .app {
      width:100%;
      height:100vh;
      display:grid;
      grid-template-columns:260px 1fr 220px;
      gap:0;
      overflow:hidden;
      align-items:stretch;
    }

    /* Sidebar (left) */
    .sidebar{
      background:var(--panel);
      border-right:1px solid var(--border);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      height:100vh;
      overflow:auto;
      flex-shrink:0;
    }
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;color:var(--accent);font-size:18px;white-space:nowrap}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px rgba(88,101,242,0.22)}
    .usernameBox{display:flex;gap:8px;align-items:center}
    .usernameBox input{flex:1;padding:8px;background:transparent;border:1px solid var(--border);border-radius:8px;color:inherit;outline:none;min-width:0}
    .usernameBox button{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer}
    .usernameLocked{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid var(--border);font-weight:600;overflow:hidden}
    .usernameLocked #usernameDisplay{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;max-width:100%}

    .channels{margin-top:6px;display:flex;flex-direction:column;gap:6px}
    .channel{padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer;border:1px solid transparent;display:flex;justify-content:space-between;align-items:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .channel:hover{background:rgba(255,255,255,0.01)}
    .channel.active{background:linear-gradient(90deg, rgba(88,101,242,0.12), rgba(88,101,242,0.02));color:var(--text);border-color:rgba(88,101,242,0.12)}

    .settings{margin-top:auto;display:flex;flex-direction:column;gap:8px;padding-top:8px;border-top:1px solid var(--border)}
    .settings label{font-size:13px;color:var(--muted);display:flex;flex-direction:column;gap:6px}
    .settings input[type="color"]{width:48px;height:32px;padding:0;border:none;background:transparent;cursor:pointer}
    .settings .toggleBtn{padding:8px;border-radius:8px;background:transparent;border:1px solid var(--border);color:var(--muted);cursor:pointer}

    /* Main chat */
    .chatPanel{display:flex;flex-direction:column;background:transparent;position:relative;min-height:0}
    .header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
    .header h2{margin:0;font-size:18px}
    .header .spacer{flex:1}
    .messages{flex:1;overflow:auto;padding:20px;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth;min-height:0}
    .message{display:flex;gap:12px;align-items:flex-start;max-width:85%}
    .message.me{margin-left:auto;justify-content:flex-end}
    .bubble{background:var(--msg-bg);padding:10px 12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);display:flex;flex-direction:column;gap:6px;color:#dbe8ff;word-break:break-word}
    .message.me .bubble{background:var(--me-bg)}
    .meta{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)}
    .meta .name{font-weight:700}
    .meta .time{font-size:12px;color:var(--muted)}
    .text{white-space:pre-wrap;color:inherit;font-size:15px;word-break:break-word;overflow-wrap:break-word}

    .inputArea{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .inputArea textarea{flex:1;min-height:44px;max-height:160px;resize:none;padding:10px;border-radius:10px;background:transparent;border:1px solid var(--border);color:inherit;outline:none;min-width:0}
    .controls{display:flex;flex-direction:column;align-items:flex-end;gap:6px;min-width:120px}
    .charCount{font-size:12px;color:var(--muted)}
    .sendBtn{background:var(--accent);border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600}
    .sendBtn:disabled{opacity:0.6;cursor:default}

    /* Right players panel */
    .playersPanel{
      background:var(--panel);
      border-left:1px solid var(--border);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      height:100vh;
      overflow:auto;
      flex-shrink:0;
    }
    .playersPanel h3{margin:0;font-size:15px;color:var(--muted)}
    .playersList{display:flex;flex-direction:column;gap:6px;overflow:auto}
    .player{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid transparent;color:var(--text)}
    .player.offline{opacity:0.6}
    .player .statusDot{width:10px;height:10px;border-radius:50%;margin-right:8px;flex-shrink:0}
    .player.online .statusDot{background:#39d353;box-shadow:0 0 8px rgba(57,211,83,0.12)}
    .player.offline .statusDot{background:#a0a0a0}

    @media (max-width:980px){
      .app{grid-template-columns:220px 1fr 180px}
    }
    @media (max-width:720px){
      .app{grid-template-columns:1fr}
      .sidebar,.playersPanel{display:none}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand"><div class="dot" aria-hidden></div>notcord</div>

      <div id="usernameSection">
        <div class="usernameBox" id="usernameBox">
          <input type="text" id="usernameInput" placeholder="Choose username (once)" maxlength="40" />
          <button id="setNameBtn">Set</button>
        </div>
        <div class="usernameLocked" id="usernameLocked" style="display:none">
          <div id="usernameDisplay"></div>
        </div>
      </div>

      <div class="channels" id="channels">
        <div class="channel active" data-id="general" role="button"># general</div>
        <div class="channel" data-id="school" role="button"># school</div>
        <div class="channel" data-id="games" role="button"># games</div>
      </div>

      <div class="settings" aria-label="Appearance settings">
        <label>
          Your name color
          <div style="display:flex;gap:8px;align-items:center">
            <input type="color" id="nameColor" title="Name color" />
            <div style="flex:1"></div>
            <button id="resetNameColor" class="toggleBtn">Reset</button>
          </div>
        </label>

        <label>
          Theme color 1
          <div style="display:flex;gap:8px;align-items:center">
            <input type="color" id="themeColor1" title="Theme color 1" />
            <div style="flex:1"></div>
            <button id="resetTheme1" class="toggleBtn">Reset</button>
          </div>
        </label>

        <label>
          Theme color 2
          <div style="display:flex;gap:8px;align-items:center">
            <input type="color" id="themeColor2" title="Theme color 2" />
            <div style="flex:1"></div>
            <button id="resetTheme2" class="toggleBtn">Reset</button>
          </div>
        </label>

        <div style="font-size:12px;color:var(--muted);padding-top:6px">Username and appearance are saved in this browser.</div>
      </div>
    </aside>

    <section class="chatPanel">
      <div class="header">
        <h2 id="channelTitle"># general</h2>
        <div class="spacer"></div>
        <div id="status" style="color:var(--muted);font-size:13px">Connecting...</div>
      </div>

      <div class="messages" id="messages" role="log" aria-atomic="false"></div>

      <div class="inputArea">
        <textarea id="messageInput" placeholder="Message (Shift+Enter for newline)" maxlength="100"></textarea>
        <div class="controls">
          <div class="charCount" id="charCount">0 / 100</div>
          <button id="sendBtn" class="sendBtn" disabled>Send</button>
        </div>
      </div>
    </section>

    <aside class="playersPanel" id="playersPanel">
      <h3>Players</h3>
      <div id="playersStatus" style="font-size:13px;color:var(--muted)">Loading...</div>
      <div style="height:6px"></div>
      <div class="playersList" id="playersList" aria-live="polite"></div>
    </aside>
  </div>

  <script>
    (function(){
      // API endpoints
      const CHANNELS = {
        general: 'https://68e839b2f2707e6128ca35e1.mockapi.io/chat',
        school:  'https://68eeed86b06cc802829ba196.mockapi.io/schoolchat',
        games:   'https://68eeed86b06cc802829ba196.mockapi.io/gameschat'
      };
      const PLAYERS_API = 'https://68e839b2f2707e6128ca35e1.mockapi.io/players';

      // DOM
      const rootEl = document.documentElement;
      const channelsEl = document.getElementById('channels');
      const channelTitleEl = document.getElementById('channelTitle');
      const messagesEl = document.getElementById('messages');
      const statusEl = document.getElementById('status');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const charCountEl = document.getElementById('charCount');

      const usernameBox = document.getElementById('usernameBox');
      const usernameInput = document.getElementById('usernameInput');
      const setNameBtn = document.getElementById('setNameBtn');
      const usernameLocked = document.getElementById('usernameLocked');
      const usernameDisplay = document.getElementById('usernameDisplay');

      const nameColorInput = document.getElementById('nameColor');
      const themeColor1Input = document.getElementById('themeColor1');
      const themeColor2Input = document.getElementById('themeColor2');
      const resetNameColorBtn = document.getElementById('resetNameColor');
      const resetTheme1Btn = document.getElementById('resetTheme1');
      const resetTheme2Btn = document.getElementById('resetTheme2');

      const playersListEl = document.getElementById('playersList');
      const playersStatusEl = document.getElementById('playersStatus');

      // state
      let activeChannel = localStorage.getItem('notcord_channel') || 'general';
      let apiBase = CHANNELS[activeChannel];
      let polling = null;
      let playersPolling = null;
      let isSending = false;
      const MAX_CHARS = 100;

      // user settings
      let username = localStorage.getItem('notcord_username') || '';
      let nameColor = localStorage.getItem('notcord_nameColor') || '#ffcc00';
      let themeColor1 = localStorage.getItem('notcord_theme1') || '#071226';
      let themeColor2 = localStorage.getItem('notcord_theme2') || '#07101a';
      // accent uses themeColor1 by default
      let accentColor = localStorage.getItem('notcord_accent') || themeColor1;

      // apply theme (two color gradient)
      function applyTheme(){
        document.documentElement.style.setProperty('--theme-1', themeColor1);
        document.documentElement.style.setProperty('--theme-2', themeColor2);
        document.documentElement.style.setProperty('--accent', accentColor || themeColor1);
      }

      function initializeAppearanceInputs(){
        nameColorInput.value = nameColor;
        themeColor1Input.value = themeColor1;
        themeColor2Input.value = themeColor2;
      }

      function setStatus(txt){
        statusEl.textContent = txt;
      }

      // rendering messages
      function detectNameColorFromMsg(msg){
        // try common field names
        return msg.nameColor || msg.color || msg.name_color || msg.colorHex || msg.colour || null;
      }

      function renderMessage(msg, isMe=false){
        const container = document.createElement('div');
        container.className = 'message' + (isMe ? ' me' : '');

        const bubble = document.createElement('div');
        bubble.className = 'bubble';

        const meta = document.createElement('div');
        meta.className = 'meta';
        const name = document.createElement('span');
        name.className = 'name';
        const author = msg.username || msg.name || msg.author || 'Unknown';
        name.textContent = author;

        // color precedence:
        // 1) color provided in message (from API)
        // 2) if author is local user, use local nameColor
        // 3) default (inherit)
        const msgColor = detectNameColorFromMsg(msg);
        if(msgColor){
          name.style.color = msgColor;
        } else if(author === username && nameColor){
          name.style.color = nameColor;
        }

        const time = document.createElement('span');
        time.className = 'time';
        const created = msg.createdAt || msg.created_at || msg.timestamp || msg.time || '';
        time.textContent = formatTime(created);

        meta.appendChild(name);
        meta.appendChild(time);

        const text = document.createElement('div');
        text.className = 'text';
        text.textContent = msg.message || msg.text || msg.content || msg.body || '';

        bubble.appendChild(meta);
        bubble.appendChild(text);
        container.appendChild(bubble);
        return container;
      }

      function formatTime(iso){
        try{
          const d = new Date(iso);
          if(isNaN(d)) return '';
          return d.toLocaleString([], { hour: '2-digit', minute: '2-digit' });
        }catch(e){ return ''; }
      }

      function scrollToBottom(){
        requestAnimationFrame(()=> { messagesEl.scrollTop = messagesEl.scrollHeight; });
      }

      // fetch messages
      async function fetchMessages(){
        if(!apiBase) return false;
        try{
          const res = await fetch(apiBase);
          if(!res.ok) throw new Error('Fetch failed: ' + res.status);
          const data = await res.json();
          if(!Array.isArray(data)) return false;

          data.sort((a,b)=>{
            const ta = new Date(a.createdAt||a.created_at||a.timestamp||0).getTime() || (Number(a.id)||0);
            const tb = new Date(b.createdAt||b.created_at||b.timestamp||0).getTime() || (Number(b.id)||0);
            return ta - tb;
          });

          // render all
          messagesEl.innerHTML = '';
          for(const msg of data){
            const author = msg.username || msg.name || msg.author || '';
            const isMe = (author === username);
            const el = renderMessage(msg, isMe);
            messagesEl.appendChild(el);
          }
          scrollToBottom();
          setStatus('Connected â€” ' + data.length + ' messages');
          return true;
        }catch(err){
          console.error(err);
          setStatus('Error fetching messages');
          return false;
        }
      }

      // post message with name color included so others see it
      async function postMessage(text){
        if(!text || !text.trim()) return;
        if(!username){ setStatus('Set username first'); return; }
        if(!apiBase){ setStatus('No channel selected'); return; }
        if(isSending) return;
        isSending = true;
        sendBtn.disabled = true;

        const payload = {
          username: username,
          message: text.trim(),
          createdAt: new Date().toISOString(),
          nameColor: nameColor
        };

        // optimistic UI
        const optimisticEl = renderMessage(payload, true);
        messagesEl.appendChild(optimisticEl);
        scrollToBottom();

        try{
          const res = await fetch(apiBase, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if(!res.ok) throw new Error('Send failed: ' + res.status);
          // refetch to reconcile (and pick up saved color)
          await fetchMessages();
        }catch(err){
          console.error(err);
          setStatus('Failed to send message');
          const timeEl = optimisticEl.querySelector('.meta .time');
          if(timeEl) timeEl.textContent += ' (failed)';
        }finally{
          isSending = false;
          sendBtn.disabled = false;
        }
      }

      // channels
      async function setActiveChannel(id){
        activeChannel = id;
        apiBase = CHANNELS[id];
        localStorage.setItem('notcord_channel', id);
        Array.from(channelsEl.children).forEach(ch => ch.classList.toggle('active', ch.dataset.id === id));
        channelTitleEl.textContent = '# ' + id;
        if(polling) clearInterval(polling);
        await fetchMessages();
        scrollToBottom();
        polling = setInterval(fetchMessages, 4000);
      }

      // username logic (set once)
      function lockUsernameUI(){
        usernameBox.style.display = 'none';
        usernameLocked.style.display = 'flex';
        usernameDisplay.textContent = username;
      }

      // appearance
      function applyNameColor(c){
        nameColor = c;
        localStorage.setItem('notcord_nameColor', nameColor);
        // update existing messages (for local user's name)
        Array.from(messagesEl.querySelectorAll('.meta .name')).forEach(el=>{
          if(el.textContent === username) el.style.color = nameColor;
        });
      }

      function applyThemeColor1(c){
        themeColor1 = c;
        localStorage.setItem('notcord_theme1', themeColor1);
        accentColor = themeColor1;
        localStorage.setItem('notcord_accent', accentColor);
        applyTheme();
      }
      function applyThemeColor2(c){
        themeColor2 = c;
        localStorage.setItem('notcord_theme2', themeColor2);
        applyTheme();
      }

      // players panel
      function normalizePlayerName(p){
        return p.name || p.username || p.nick || p.displayName || p.id || String(p);
      }
      function detectPlayerOnline(p){
        if(typeof p.online === 'boolean') return p.online;
        if(typeof p.active === 'boolean') return p.active;
        if(typeof p.isOnline === 'boolean') return p.isOnline;
        if(typeof p.status === 'string') return p.status.toLowerCase().includes('online');
        if(typeof p.online === 'string') return p.online.toLowerCase() === 'true';
        return false;
      }

      async function fetchPlayers(){
        try{
          const res = await fetch(PLAYERS_API);
          if(!res.ok) throw new Error('Players fetch failed: ' + res.status);
          const data = await res.json();
          if(!Array.isArray(data)) {
            playersStatusEl.textContent = 'No players data';
            playersListEl.innerHTML = '';
            return;
          }

          const online = [];
          const offline = [];
          for(const p of data){
            const name = normalizePlayerName(p);
            const on = detectPlayerOnline(p);
            if(on) online.push({name, raw:p});
            else offline.push({name, raw:p});
          }

          // render
          playersListEl.innerHTML = '';
          const headerOnline = document.createElement('div');
          headerOnline.style.fontSize = '13px';
          headerOnline.style.color = 'var(--muted)';
          headerOnline.textContent = 'Online (' + online.length + ')';
          playersListEl.appendChild(headerOnline);

          for(const p of online){
            const item = document.createElement('div');
            item.className = 'player online';
            item.innerHTML = `<div style="display:flex;align-items:center"><span class="statusDot" aria-hidden></span><span style="font-weight:600">${escapeHtml(p.name)}</span></div><div style="font-size:12px;color:var(--muted)">online</div>`;
            playersListEl.appendChild(item);
          }

          const sep = document.createElement('div');
          sep.style.height = '8px';
          playersListEl.appendChild(sep);

          const headerOff = document.createElement('div');
          headerOff.style.fontSize = '13px';
          headerOff.style.color = 'var(--muted)';
          headerOff.textContent = 'Offline (' + offline.length + ')';
          playersListEl.appendChild(headerOff);

          for(const p of offline){
            const item = document.createElement('div');
            item.className = 'player offline';
            item.innerHTML = `<div style="display:flex;align-items:center"><span class="statusDot" aria-hidden></span><span style="font-weight:600">${escapeHtml(p.name)}</span></div><div style="font-size:12px;color:var(--muted)">offline</div>`;
            playersListEl.appendChild(item);
          }

          playersStatusEl.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
        }catch(err){
          console.error(err);
          playersStatusEl.textContent = 'Error loading players';
        }
      }

      // helpers
      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      }

      // inputs & controls
      function updateCharCountAndState(){
        let val = messageInput.value || '';
        if(val.length > MAX_CHARS){
          messageInput.value = val.slice(0, MAX_CHARS);
          val = messageInput.value;
        }
        charCountEl.textContent = `${val.length} / ${MAX_CHARS}`;
        const canSend = username && val.trim().length > 0;
        sendBtn.disabled = !canSend || isSending;
      }

      // event bindings
      channelsEl.addEventListener('click', (e)=>{
        const ch = e.target.closest('.channel');
        if(!ch) return;
        setActiveChannel(ch.dataset.id).catch(()=>{});
      });

      setNameBtn.addEventListener('click', ()=>{
        let val = usernameInput.value.trim();
        if(!val) val = 'Guest' + Math.floor(Math.random()*9000 + 1000);
        username = val;
        localStorage.setItem('notcord_username', username);
        lockUsernameUI();
        setStatus('Username set: ' + username);
        updateCharCountAndState();
      });

      sendBtn.addEventListener('click', ()=>{
        const txt = messageInput.value;
        if(!txt.trim()) return;
        postMessage(txt);
        messageInput.value = '';
        updateCharCountAndState();
      });

      messageInput.addEventListener('input', (e)=>{
        if(messageInput.value.length > MAX_CHARS){
          messageInput.value = messageInput.value.slice(0, MAX_CHARS);
        }
        updateCharCountAndState();
      });

      messageInput.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          if(!sendBtn.disabled) sendBtn.click();
        }
      });

      nameColorInput.addEventListener('input', (e)=> {
        applyNameColor(e.target.value);
      });
      resetNameColorBtn.addEventListener('click', ()=>{
        applyNameColor('#ffcc00');
        nameColorInput.value = '#ffcc00';
      });

      themeColor1Input.addEventListener('input', (e)=> {
        applyThemeColor1(e.target.value);
      });
      resetTheme1Btn.addEventListener('click', ()=>{
        applyThemeColor1('#071226');
        themeColor1Input.value = '#071226';
      });

      themeColor2Input.addEventListener('input', (e)=> {
        applyThemeColor2(e.target.value);
      });
      resetTheme2Btn.addEventListener('click', ()=>{
        applyThemeColor2('#07101a');
        themeColor2Input.value = '#07101a';
      });

      // init
      async function init(){
        // apply saved settings
        nameColor = localStorage.getItem('notcord_nameColor') || nameColor;
        themeColor1 = localStorage.getItem('notcord_theme1') || themeColor1;
        themeColor2 = localStorage.getItem('notcord_theme2') || themeColor2;
        accentColor = localStorage.getItem('notcord_accent') || themeColor1;
        applyTheme();
        initializeAppearanceInputs();

        // username UI
        if(username){
          lockUsernameUI();
        } else {
          usernameBox.style.display = 'flex';
          usernameLocked.style.display = 'none';
        }

        // channel
        await setActiveChannel(activeChannel);

        // players
        await fetchPlayers();
        if(playersPolling) clearInterval(playersPolling);
        playersPolling = setInterval(fetchPlayers, 5000);

        // messages polling (already started in setActiveChannel)
        setStatus('Connected (polling every 4s)');

        // ensure bottom after any layout timing issues
        setTimeout(scrollToBottom, 120);
      }

      init();

      // cleanup on unload
      window.addEventListener('beforeunload', ()=> {
        if(polling) clearInterval(polling);
        if(playersPolling) clearInterval(playersPolling);
      });
    })();
  </script>
</body>
</html>
