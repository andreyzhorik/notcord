<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>notcord</title>
  <style>
    :root{
      --bg:#0f1720;
      --panel:#0b1220;
      --muted:#9aa4b2;
      --accent:#5865f2;
      --msg-bg:#111827;
      --me-bg:#2b3440;
      --border: rgba(255,255,255,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#e6eef6;background:linear-gradient(180deg,#071226 0%, #07101a 100%);}
    /* Fullscreen app */
    .app {
      height:100vh;
      width:100vw;
      display:flex;
      flex-direction:column;
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      overflow:hidden;
    }

    /* Header */
    .header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 18px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    }
    .brand{
      display:flex;
      gap:10px;
      align-items:center;
      font-weight:700;
      color:var(--accent);
      font-size:18px;
    }
    .brand .dot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px rgba(88,101,242,0.6);}

    .header .right{
      margin-left:auto;
      display:flex;
      gap:12px;
      align-items:center;
      color:var(--muted);
      font-size:14px;
    }
    .usernameDisplay{
      padding:6px 10px;
      border-radius:8px;
      background:rgba(255,255,255,0.02);
      border:1px solid var(--border);
      color:#e6eef6;
      font-weight:600;
    }

    /* main area */
    .messages{
      flex:1;
      overflow:auto;
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:12px;
      scroll-behavior:smooth;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    }

    .message{
      display:flex;
      gap:12px;
      align-items:flex-start;
      max-width:80%;
      margin-left:0;
    }
    .message.me{margin-left:auto; justify-content:flex-end;}
    .bubble{
      background:var(--msg-bg);
      padding:10px 12px;
      border-radius:12px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.6);
      display:flex;
      flex-direction:column;
      gap:6px;
      word-wrap:break-word;
      color:#dbe8ff;
      font-size:15px;
    }
    .message.me .bubble{background:var(--me-bg);}

    .meta{
      display:flex;
      gap:8px;
      align-items:center;
      font-size:13px;
      color:var(--muted);
    }
    .meta .name{color:#e6eef6;font-weight:600}
    .meta .time{font-size:12px;color:var(--muted)}

    /* input */
    .inputArea{
      padding:12px;
      border-top:1px solid var(--border);
      display:flex;
      gap:8px;
      align-items:flex-end;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    }
    .inputArea textarea{
      flex:1;
      min-height:44px;
      max-height:140px;
      resize:none;
      padding:10px;
      border-radius:10px;
      background:transparent;
      border:1px solid var(--border);
      color:inherit;
      outline:none;
      font-family:inherit;
    }
    .sendBtn{
      background:var(--accent);
      border:none;
      color:white;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:600;
    }
    .sendBtn:disabled{opacity:0.6;cursor:default}

    /* small adjustments */
    @media (max-width:600px){
      .header{padding:10px}
      .brand{font-size:16px}
    }

    /* username setup bar (top of messages if name not set) */
    .nameSetup{
      display:flex;
      gap:8px;
      align-items:center;
      padding:10px;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
      border-bottom:1px solid var(--border);
    }
    .nameSetup input{
      padding:8px 10px;
      border-radius:8px;
      background:transparent;
      border:1px solid var(--border);
      color:inherit;
      outline:none;
      min-width:180px;
    }
    .nameSetup button{
      padding:8px 12px;
      border-radius:8px;
      background:var(--accent);
      color:white;
      border:none;
      cursor:pointer;
      font-weight:600;
    }
    .status{padding:8px 14px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="header">
      <div class="brand"><div class="dot" aria-hidden></div>notcord</div>
      <div class="right">
        <div id="status" class="status">Connecting...</div>
        <div id="usernameDisplay" class="usernameDisplay" style="display:none"></div>
      </div>
    </div>

    <!-- If username not set, show setup bar -->
    <div id="nameSetup" class="nameSetup" style="display:none">
      <input type="text" id="username" placeholder="Set your username (once)" maxlength="40" />
      <button id="saveName">Set name</button>
      <div style="flex:1"></div>
      <div style="color:var(--muted);font-size:13px">Name is permanent for this browser (clear storage to change)</div>
    </div>

    <div class="messages" id="messages" role="log" aria-atomic="false"></div>

    <div class="inputArea">
      <textarea id="messageInput" placeholder="Message #general (Shift+Enter for newline)"></textarea>
      <button class="sendBtn" id="sendBtn">Send</button>
    </div>
  </div>

  <script>
    (function(){
      const API_BASE = 'https://68e839b2f2707e6128ca35e1.mockapi.io/chat';
      // DOM
      const messagesEl = document.getElementById('messages');
      const usernameInput = document.getElementById('username');
      const saveNameBtn = document.getElementById('saveName');
      const statusEl = document.getElementById('status');
      const usernameDisplay = document.getElementById('usernameDisplay');
      const nameSetupBar = document.getElementById('nameSetup');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');

      // state
      let username = localStorage.getItem('notcord_username') || '';
      let polling = null;
      let isSending = false;

      // utils
      function generateGuest(){
        return 'Guest' + Math.floor(Math.random()*9000 + 1000);
      }
      function sanitizeText(str){
        return String(str || '');
      }
      function formatTime(iso){
        try{
          const d = new Date(iso);
          if(isNaN(d)) return '';
          return d.toLocaleString([], { hour: '2-digit', minute: '2-digit' });
        }catch(e){ return '';}
      }
      function findMessageText(msg){
        return msg.message || msg.text || msg.content || msg.body || '';
      }
      function findMessageAuthor(msg){
        return msg.username || msg.name || msg.author || 'Unknown';
      }

      // rendering
      function renderMessage(msg, isMe=false){
        const container = document.createElement('div');
        container.className = 'message' + (isMe ? ' me' : '');

        const bubble = document.createElement('div');
        bubble.className = 'bubble';

        const meta = document.createElement('div');
        meta.className = 'meta';
        const name = document.createElement('span');
        name.className = 'name';
        name.textContent = findMessageAuthor(msg);

        const time = document.createElement('span');
        time.className = 'time';
        time.textContent = formatTime(msg.createdAt || msg.created_at || msg.timestamp || msg.time || '');

        meta.appendChild(name);
        meta.appendChild(time);

        const text = document.createElement('div');
        text.className = 'text';
        text.textContent = findMessageText(msg);

        bubble.appendChild(meta);
        bubble.appendChild(text);

        container.appendChild(bubble);
        return container;
      }

      function setStatus(txt){
        statusEl.textContent = txt;
      }

      // fetch messages
      async function fetchMessages(){
        try{
          const res = await fetch(API_BASE);
          if(!res.ok) throw new Error('Fetch failed: ' + res.status);
          const data = await res.json();
          if(!Array.isArray(data)) return;

          // sort by createdAt or id
          data.sort((a,b) => {
            const ta = new Date(a.createdAt || a.created_at || a.timestamp || 0).getTime() || (Number(a.id) || 0);
            const tb = new Date(b.createdAt || b.created_at || b.timestamp || 0).getTime() || (Number(b.id) || 0);
            return ta - tb;
          });

          // render
          messagesEl.innerHTML = '';
          for(const msg of data){
            const isMe = (findMessageAuthor(msg) === username);
            const el = renderMessage(msg, isMe);
            messagesEl.appendChild(el);
          }
          scrollToBottom();
          setStatus('Connected â€” ' + data.length + ' messages');
        }catch(err){
          console.error(err);
          setStatus('Error fetching messages');
        }
      }

      // post message
      async function postMessage(text){
        if(!text || text.trim().length === 0) return;
        if(!username) { setStatus('Set a username first'); return; }
        if(isSending) return;
        isSending = true;
        sendBtn.disabled = true;

        const payload = {
          username: username,
          message: text,
          createdAt: new Date().toISOString()
        };

        // optimistic UI
        const optimisticEl = renderMessage(payload, true);
        messagesEl.appendChild(optimisticEl);
        scrollToBottom();

        try{
          const res = await fetch(API_BASE, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if(!res.ok) throw new Error('Send failed: ' + res.status);
          // reconcile by refetching
          await fetchMessages();
        }catch(err){
          console.error(err);
          setStatus('Failed to send message');
          // mark failed
          const timeEl = optimisticEl.querySelector('.meta .time');
          if(timeEl) timeEl.textContent += ' (failed)';
        }finally{
          isSending = false;
          sendBtn.disabled = false;
        }
      }

      function scrollToBottom(){
        requestAnimationFrame(()=> messagesEl.scrollTop = messagesEl.scrollHeight);
      }

      // username logic: show setup if not set, otherwise lock
      function initializeUsernameUI(){
        if(username){
          usernameDisplay.style.display = 'block';
          usernameDisplay.textContent = username;
          nameSetupBar.style.display = 'none';
        } else {
          nameSetupBar.style.display = 'flex';
          usernameInput.value = '';
        }
      }

      saveNameBtn.addEventListener('click', ()=>{
        let val = usernameInput.value.trim();
        if(!val) val = generateGuest();
        // set once: store and lock UI
        username = val;
        localStorage.setItem('notcord_username', username);
        usernameDisplay.textContent = username;
        usernameDisplay.style.display = 'block';
        nameSetupBar.style.display = 'none';
        setStatus('Username set: ' + username);
      });

      sendBtn.addEventListener('click', ()=> {
        const text = messageInput.value;
        if(!text.trim()) return;
        postMessage(text.trim());
        messageInput.value = '';
      });

      messageInput.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          sendBtn.click();
        }
      });

      // init
      initializeUsernameUI();
      fetchMessages();
      setStatus('Connected (polling every 4s)');
      polling = setInterval(fetchMessages, 4000);

      window.addEventListener('beforeunload', ()=> {
        if(polling) clearInterval(polling);
      });

      // focus input
      messageInput.focus();
    })();
  </script>
</body>
</html>
